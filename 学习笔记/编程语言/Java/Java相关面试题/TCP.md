# 一、TCP

## 1.1  三次握手

- 服务器B处于LISTEN(监听)状态，等待连接
- 客户端A发送一个连接请求报文SYN(seq为发送序号)给服务器B
- 服务器B收到连接请求后，如果同意建立连接，给A发送一个连接确认报文SYN ACK(ack的值为请求报文的发送序号+1，seq为确认报文的发送序号)
- 客户端A收到服务器B发来的SYN ACK后，还要向B发出确认报文ACK(ack为上个报文的seq+1）
- B收到ACK后，连接建立

- 三次握手的原因

	- 第三次握手的原因是为了防止失效的连接请求到达服务器，让服务器错误的打开了连接
	- 客户端发送的连接请求如果在网络中滞留，那么就会隔很长的一段时间才能收到服务端发回的连接确认，客户端等待一个超时重传时间之后，就会重新请求连接，但是这个滞留的连接请求最后还是会到达服务器，如果不进行三次握手，那么服务器就会打开两个连接，如果有三次握手，客户端会忽略服务器之后发送的对滞留连接请求的连接确认，不进行第三次握手，因此就不会再次打开连接。

## 1.2 四次挥手

- A发送连接释放报文FIN ACK(seq=1,ack=1369)
- B收到FIN之后发出确认ACK(seq=1369,ack=2)，进入CLOSE-WAIT状态，此时TCP处于半关闭状态，A不能向B发送数据，B可以给A发送数据
- 当B不在需要连接时，给A发送连接释放报文FIN ACK(seq=1369,ack=2)
- A收到FIN之后发出确认ACK(seq=2,ack=1370)，进入TIME-WAIT状态，等待2倍的MSL(最大报文存活时间)后释放连接
- B收到ACK之后释放连接

- TIME-WAIT状态

	- 确保最后一个确认报文ACK能够到达，如果服务端没有收到客户端发送来的确认报文ACK，那么就需要重新发送连接释放报文FIN，客户端等待一段时间就是为了处理这种情况的发生
	- 等待一段时间是为了让本次连接持续时间内产生的所有报文都从网络中消失，使得下一个新的连接不会出现旧的连接请求报文SYN，从而错误的打开连接。

## 1.3 TCP的可靠传输

- 超时重传

## 1.4 TCP滑动窗口

- 发送方和接收方各有一个窗口
	- 如果发送窗口左部的字节已经发送并且收到确认，那么发送窗口向右滑动一定距离
	- 接受方只会对窗口内最后一个按序到达的字节进行确认

## 1.5 TCP流量控制

- 流量控制是为了控制发送方发送速率，保证接收方来得及接收
- 接收方可以在确认报文中的窗口字段设置发送方的窗口大小，从而影响发送发的发送速率

## 1.6 TCP拥塞控制

- 慢开始
- 拥塞避免
	- 发送方需要维护一个叫做拥塞窗口(cwnd)的状态变量，首先发送方最初执行慢开始，令cwnd=1，发送方只能发送一个报文段，当收到确认后，，每次将cwnd加倍，设置一个慢开始的门限，当cwnd大于该门限时，每次cwnd加1
	- 如果出现了超时，则将门限=cwnd/2，重新执行慢开始
- 快重传
- 快恢复
	- 接收方每次发送的确认报文是最后一个收到的有序报文段
	- 在发送方如果连续收到三次重复确认，表明之后的报文丢失，需要进行快重传
	- 快重传之后执行快恢复，将cwnd的值设置为门限值。

# UDP

## 1.1 UDP首部格式

- UDP首部格式只有8个字节：源端口、目的端口、长度、校验和
- 12字节长度的伪首部是为了计算校验和临时添加的